name: Terraform CI/CD Pipeline

on:
  push:
    branches: [ main, staging ]
    paths:
      - 'infrastructure/**'
      - '.github/workflows/**'
  pull_request:
    branches: [ main ]
    paths:
      - 'infrastructure/**'

env:
  AWS_REGION: us-east-1
  TF_VERSION: 1.5.0
  TF_WORKING_DIR: './infrastructure'

permissions:
  id-token: write
  contents: read
  pull-requests: write

jobs:
  terraform-validation:
    name: Terraform Validation
    runs-on: ubuntu-latest
    environment: development
    
    steps:
    - name: Checkout Repository
      uses: actions/checkout@v3
    
    - name: Setup Terraform
      uses: hashicorp/setup-terraform@v2
      with:
        terraform_version: ${{ env.TF_VERSION }}
    
    - name: Terraform Format
      id: fmt
      run: terraform fmt -check -recursive
      working-directory: ${{ env.TF_WORKING_DIR }}
    
    - name: Terraform Init
      id: init
      run: terraform init -backend=false
      working-directory: ${{ env.TF_WORKING_DIR }}
    
    - name: Terraform Validate
      id: validate
      run: terraform validate
      working-directory: ${{ env.TF_WORKING_DIR }}
    
    - name: Terraform Plan
      id: plan
      run: terraform plan -var-file="terraform.tfvars.example" -out=tfplan
      working-directory: ${{ env.TF_WORKING_DIR }}
    
    - name: Upload Plan Artifact
      uses: actions/upload-artifact@v3
      with:
        name: tfplan
        path: ${{ env.TF_WORKING_DIR }}/tfplan
  
  security-scan:
    name: Security Scanning
    runs-on: ubuntu-latest
    needs: terraform-validation
    
    steps:
    - name: Checkout Repository
      uses: actions/checkout@v3
    
    - name: Run TFSec
      uses: aquasecurity/tfsec-pr-action@master
      with:
        directory: ${{ env.TF_WORKING_DIR }}
        soft_fail: true
    
    - name: Run Checkov
      uses: bridgecrewio/checkov-action@master
      with:
        directory: ${{ env.TF_WORKING_DIR }}
        framework: terraform
        quiet: true
        soft_fail: true
    
    - name: Run Terrascan
      uses: accurics/terrascan-action@v1.1.0
      with:
        iac_type: terraform
        iac_version: v14
        policy_type: aws
        only_warn: true
  
  terraform-apply:
    name: Terraform Apply
    runs-on: ubuntu-latest
    needs: [terraform-validation, security-scan]
    if: github.event_name == 'push' && (github.ref == 'refs/heads/main' || github.ref == 'refs/heads/staging')
    
    environment: 
      name: ${{ github.ref == 'refs/heads/main' && 'production' || 'staging' }}
      url: ${{ steps.deploy.outputs.application_url }}
    
    steps:
    - name: Checkout Repository
      uses: actions/checkout@v3
    
    - name: Configure AWS Credentials
      uses: aws-actions/configure-aws-credentials@v2
      with:
        role-to-assume: ${{ secrets.AWS_ROLE_ARN }}
        aws-region: ${{ env.AWS_REGION }}
    
    - name: Setup Terraform
      uses: hashicorp/setup-terraform@v2
      with:
        terraform_version: ${{ env.TF_VERSION }}
    
    - name: Download Plan Artifact
      uses: actions/download-artifact@v3
      with:
        name: tfplan
        path: ${{ env.TF_WORKING_DIR }}
    
    - name: Terraform Init
      run: terraform init
      working-directory: ${{ env.TF_WORKING_DIR }}
    
    - name: Terraform Apply
      id: deploy
      run: |
        if [ -f tfplan ]; then
          terraform apply tfplan
        else
          terraform apply -var-file="terraform.tfvars" -auto-approve
        fi
        
        # Capture outputs
        terraform output -json > tf_outputs.json
        echo "application_url=$(terraform output -raw alb_dns_name)" >> $GITHUB_OUTPUT
      working-directory: ${{ env.TF_WORKING_DIR }}
    
    - name: Upload Terraform Outputs
      uses: actions/upload-artifact@v3
      with:
        name: terraform-outputs
        path: ${{ env.TF_WORKING_DIR }}/tf_outputs.json
    
    - name: Health Check
      run: |
        ALB_DNS=$(terraform output -raw alb_dns_name)
        echo "Testing application at https://$ALB_DNS"
        
        # Wait for ALB to be ready
        sleep 30
        
        # Try health check
        for i in {1..10}; do
          STATUS=$(curl -s -o /dev/null -w "%{http_code}" https://$ALB_DNS/health.php || echo "000")
          if [ "$STATUS" = "200" ]; then
            echo "Health check passed!"
            exit 0
          fi
          echo "Attempt $i: Status $STATUS"
          sleep 10
        done
        
        echo "Health check failed!"
        exit 1
      working-directory: ${{ env.TF_WORKING_DIR }}
    
    - name: Notify Success
      if: success()
      run: |
        echo "Deployment completed successfully!"
        echo "Application URL: ${{ steps.deploy.outputs.application_url }}"
    
    - name: Notify Failure
      if: failure()
      uses: 8398a7/action-slack@v3
      with:
        channel: '#deployments'
        status: ${{ job.status }}
        text: |
          Terraform deployment failed for ${{ github.repository }}
          Branch: ${{ github.ref }}
          Commit: ${{ github.sha }}
        username: GitHub Actions
        icon_emoji: ':aws:'
      env:
        SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
  
  infrastructure-tests:
    name: Infrastructure Tests
    runs-on: ubuntu-latest
    needs: terraform-apply
    if: always()
    
    steps:
    - name: Checkout Repository
      uses: actions/checkout@v3
    
    - name: Download Terraform Outputs
      uses: actions/download-artifact@v3
      with:
        name: terraform-outputs
        path: .
    
    - name: Run Infrastructure Tests
      run: |
        # Install inspec
        curl https://omnitruck.chef.io/install.sh | sudo bash -s -- -P inspec
        
        # Parse outputs and run tests
        if [ -f tf_outputs.json ]; then
          ALB_DNS=$(jq -r '.alb_dns_name.value' tf_outputs.json)
          VPC_ID=$(jq -r '.vpc_id.value' tf_outputs.json)
          
          # Basic connectivity tests
          echo "Testing ALB connectivity..."
          curl -f https://$ALB_DNS/health.php || exit 1
          
          echo "Infrastructure tests passed!"
        else
          echo "No terraform outputs found"
          exit 1
        fi